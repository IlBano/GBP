import requests
import json
from datetime import datetime
import locale

isPost=True

if isPost:
    postdata='{"points":[{"lat":45.28470326329889,"lng":9.20064115212563},{"lat":45.28422014814266,"lng":9.228793617945943},{"lat":45.174446537781456,"lng":9.19240140603188},{"lat":45.179770851672444,"lng":9.14296292946938}],"fuelType":"1-x","priceOrder":"asc","radius":5}'

    url = "https://carburanti.mise.gov.it/ospzApi/search/zone"
    headers = {"Content-Type": "application/json"}

    response = requests.post(url, data=postdata, headers=headers)
    scode= response.status_code
    data=response.json()
else:
    scode=200
    result='{"success":true,"center":{"lat":45.230065191733715,"lng":9.18192096456239},"results":[{"id":44647,"name":"4231","fuels":[{"id":97991245,"price":1.689,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97991243,"price":1.599,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97991244,"price":1.569,"name":"HVO","fuelId":404,"isSelf":true}],"location":{"lat":45.18184898093629,"lng":9.177614235287365},"insertDate":"2025-08-02T12:58:11+02:00","address":null,"brand":"Tamoil","distance":"N.D."},{"id":59887,"name":"PAVIA","fuels":[{"id":97899722,"price":1.907,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97936038,"price":1.696,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97899720,"price":1.817,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97935968,"price":1.599,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.1897107,"lng":9.18926772},"insertDate":"2025-08-01T13:32:00+02:00","address":null,"brand":"Api-Ip","distance":"N.D."},{"id":37665,"name":"CLERICI RENZO","fuels":[{"id":97988100,"price":1.779,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97988099,"price":1.699,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97988102,"price":1.739,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97988101,"price":1.659,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.25174282675089,"lng":9.198231473565102},"insertDate":"2025-08-02T11:23:36+02:00","address":null,"brand":"Api-Ip","distance":"N.D."},{"id":31522,"name":"VEGA PAVIA","fuels":[{"id":97820254,"price":1.809,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97820253,"price":1.709,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97820325,"price":1.759,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97820324,"price":1.659,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97820001,"price":0.699,"name":"GPL","fuelId":4,"isSelf":false},{"id":97820327,"price":1.829,"name":"DieselMax","fuelId":231,"isSelf":false},{"id":97820326,"price":1.729,"name":"DieselMax","fuelId":231,"isSelf":true}],"location":{"lat":45.200954545800506,"lng":9.194373786449432},"insertDate":"2025-07-30T21:29:23+02:00","address":null,"brand":"Vega","distance":"N.D."},{"id":6457,"name":"PAVIA VIA SOLFERINO 29 IMPANTO Q8","fuels":[{"id":97960881,"price":1.714,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97960882,"price":1.654,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.1925565067323,"lng":9.181255939286757},"insertDate":"2025-08-02T01:07:14+02:00","address":null,"brand":"Q8","distance":"N.D."},{"id":14281,"name":"PAVIA VIA FOLPERTI-IMP.Q8","fuels":[{"id":97960873,"price":1.714,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97960874,"price":1.654,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.197029353434274,"lng":9.159629472422012},"insertDate":"2025-08-02T01:07:13+02:00","address":null,"brand":"Q8","distance":"N.D."},{"id":10332,"name":"Pavia","fuels":[{"id":97984654,"price":1.719,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97984655,"price":1.659,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.203529761588726,"lng":9.170570409262154},"insertDate":"2025-08-02T09:04:45+02:00","address":null,"brand":"Api-Ip","distance":"N.D."},{"id":21857,"name":"FRAZ. PONTELUNGO VIDIGULFO","fuels":[{"id":97963493,"price":1.728,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97963492,"price":1.728,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97963495,"price":1.658,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97963494,"price":1.658,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.280342746124454,"lng":9.211996323907897},"insertDate":"2025-08-02T06:01:00+02:00","address":null,"brand":"Esso","distance":"N.D."},{"id":23767,"name":"Totalerg","fuels":[{"id":97967366,"price":1.729,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97967365,"price":1.729,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97967368,"price":1.639,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97967367,"price":1.639,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.18621484965061,"lng":9.171175360679626},"insertDate":"2025-08-02T06:57:00+02:00","address":null,"brand":"Api-Ip","distance":"N.D."},{"id":50229,"name":"IP vigentina","fuels":[{"id":97940262,"price":1.947,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97940261,"price":1.729,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97940264,"price":1.887,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97940263,"price":1.669,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97940265,"price":1.549,"name":"Metano","fuelId":3,"isSelf":false},{"id":97940266,"price":0.708,"name":"GPL","fuelId":4,"isSelf":false}],"location":{"lat":45.21921888089297,"lng":9.177491393382748},"insertDate":"2025-08-01T16:37:29+02:00","address":null,"brand":"Api-Ip","distance":"N.D."},{"id":21401,"name":"SERVIZIO ESSO DI DAMIANI ANITA","fuels":[{"id":97817812,"price":1.739,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97817811,"price":1.739,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97817814,"price":1.689,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97817813,"price":1.689,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97817810,"price":1.879,"name":"Gasolio Premium","fuelId":10,"isSelf":false},{"id":97817809,"price":1.879,"name":"Gasolio Premium","fuelId":10,"isSelf":true}],"location":{"lat":45.23373450088448,"lng":9.183398857712746},"insertDate":"2025-07-30T18:10:32+02:00","address":null,"brand":"Esso","distance":"N.D."},{"id":25356,"name":"SMALP","fuels":[{"id":97987194,"price":1.759,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97987193,"price":1.759,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97987192,"price":1.709,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97987191,"price":1.709,"name":"Gasolio","fuelId":2,"isSelf":true}],"location":{"lat":45.198081106546,"lng":9.157398470898443},"insertDate":"2025-08-02T10:31:46+02:00","address":null,"brand":"KEROPETROL","distance":"N.D."},{"id":17612,"name":"ENI LARDIRAGO","fuels":[{"id":97959537,"price":1.759,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97959536,"price":1.659,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97959535,"price":1.759,"name":"Blue Diesel","fuelId":20,"isSelf":true}],"location":{"lat":45.19861701442174,"lng":9.181180000305176},"insertDate":"2025-08-02T00:24:51+02:00","address":null,"brand":"AgipEni","distance":"N.D."},{"id":30084,"name":"ENI TASSO","fuels":[{"id":97975282,"price":1.969,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97960070,"price":1.759,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97975281,"price":1.869,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97960069,"price":1.659,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97975280,"price":2.119,"name":"Blue Super","fuelId":5,"isSelf":false},{"id":97960068,"price":1.909,"name":"Blue Super","fuelId":5,"isSelf":true},{"id":97975279,"price":1.969,"name":"Blue Diesel","fuelId":20,"isSelf":false},{"id":97960067,"price":1.759,"name":"Blue Diesel","fuelId":20,"isSelf":true}],"location":{"lat":45.1931298207565,"lng":9.166656065081725},"insertDate":"2025-08-02T07:32:18+02:00","address":null,"brand":"AgipEni","distance":"N.D."},{"id":58068,"name":"02566 PAVIA","fuels":[{"id":97972328,"price":1.984,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97960080,"price":1.764,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97972327,"price":1.884,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97960079,"price":1.664,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97972326,"price":1.984,"name":"Blue Diesel","fuelId":20,"isSelf":false},{"id":97960078,"price":1.764,"name":"Blue Diesel","fuelId":20,"isSelf":true}],"location":{"lat":45.187542,"lng":9.176108},"insertDate":"2025-08-02T07:16:09+02:00","address":null,"brand":"AgipEni","distance":"N.D."},{"id":51312,"name":"KUWAT","fuels":[{"id":97938031,"price":1.999,"name":"Benzina","fuelId":1,"isSelf":false},{"id":97938030,"price":1.999,"name":"Benzina","fuelId":1,"isSelf":true},{"id":97938033,"price":1.899,"name":"Gasolio","fuelId":2,"isSelf":false},{"id":97938032,"price":1.899,"name":"Gasolio","fuelId":2,"isSelf":true},{"id":97938035,"price":2.149,"name":"Hi-Q Diesel","fuelId":6,"isSelf":false},{"id":97938034,"price":2.149,"name":"Hi-Q Diesel","fuelId":6,"isSelf":true}],"location":{"lat":45.17978763734297,"lng":9.151845605216886},"insertDate":"2025-08-01T15:09:06+02:00","address":null,"brand":"Q8","distance":"N.D."}]}'
    data = json.loads(result)

if scode != 200:
    print(f"Error: {scode}")
    exit(1)

myIds="21857;37665;50229;21401;10332;30084;58068;44647"
myIdsNames=["Pontelungo","IP Zeccone","IP Vigentina","Esso San Genesio","IP CC Carrefour","ENI TASSO","ENI Coop","Tamoil Montegrappa"]

with open("Benza.html", "w") as text_file:
    text_file.write("<html><body><table>")
    text_file.write("<tr><th>Distributore</th><th width='150' align='center'>Prezzo</th><th>Data prezzo</th></tr>\n")
    for station in data['results']:
        if str(station['id']) not in myIds.split(';'):
            continue
        for fuel in station['fuels']:
            if fuel['name'] != "Benzina":
                continue
            if not fuel['isSelf']:
                continue
            fprice=fuel['price']
        dt = datetime.fromisoformat(station['insertDate'].replace('Z', '+00:00'))
        formatted_date = dt.strftime('%d/%m/%Y')
        text_file.write(f"<tr><td>{myIdsNames[myIds.split(';').index(str(station['id']))]}</td><td align='center'>{fprice}</td><td>{formatted_date}</td></tr>\n")
    text_file.write("</table></body></html>")
    
